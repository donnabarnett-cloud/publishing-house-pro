<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Publishing House Pro - Professional Manuscript Editor</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; min-height: 100vh; }
.container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px 40px; }
h1 { font-size: 2.5em; margin-bottom: 10px; font-weight: 700; }
.subtitle { font-size: 1.1em; opacity: 0.9; }
.main-content { padding: 40px; background: #f8f9fa; min-height: 600px; }
.upload-section { text-align: center; padding: 40px; background: #f8f9fa; border-radius: 15px; }
input[type="file"] { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
.file-input-wrapper { position: relative; display: inline-block; margin: 20px 0; }
.file-input-label { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px 40px; border-radius: 999px; cursor: pointer; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
.editor-container { display: none; }
.editor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
.editor-panel { background: #f8f9fa; border-radius: 15px; padding: 25px; height: 600px; overflow: auto; }
.editor-panel h2 { color: #667eea; margin-bottom: 20px; font-size: 1.5em; display: flex; align-items: center; gap: 10px; }
.btn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px 30px; border: none; border-radius: 999px; cursor: pointer; font-size: 16px; transition: transform 0.2s, box-shadow 0.2s; margin: 5px; }
.btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102,126,234,0.4); }
.btn:disabled { opacity: 0.6; cursor: not-allowed; }
.progress { margin-top: 20px; background: #e9ecef; border-radius: 999px; height: 30px; overflow: hidden; display: none; }
.progress-bar { background: linear-gradient(90deg, #667eea, #22c55e); height: 100%; width: 0; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: 500; }
.tab-container { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; }
.tab { padding: 12px 24px; background: #e9ecef; border: none; border-radius: 10px 10px 0 0; cursor: pointer; font-size: 14px; color: #667eea; font-weight: 500; transition: all 0.2s; }
.tab.active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
.tab-content { display: none; }
.tab-content.active { display: block; }
.stat-card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
.stat-label { color: #6c757d; font-size: 14px; margin-bottom: 5px; }
.stat-value { font-size: 24px; color: #667eea; font-weight: 700; }
.issue-list { list-style: none; }
.issue-item { padding: 12px; background: white; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid #667eea; }
.highlight { background: #fef3c7; }
.highlight-add { background: #d1fae5; }
.highlight-remove { background: #fee2e2; text-decoration: line-through; }
.controls-row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
select { padding: 10px 15px; border-radius: 999px; border: 2px solid #e9ecef; font-size: 14px; }
.note { font-size: 10px; color: #6c757d; margin-top: 6px; }
textarea { width: 100%; min-height: 400px; padding: 15px; border: 2px solid #e9ecef; border-radius: 10px; font-family: 'Courier New', monospace; font-size: 14px; resize: vertical; }
@media (max-width: 900px) { .editor-grid { grid-template-columns: 1fr; } }
</style>
</head>
<body>
<div class="container">
<header>
<h1>üìö Publishing House Pro</h1>
<p class="subtitle">Professional Manuscript Editor ¬∑ Write ¬∑ Analyze ¬∑ Edit ¬∑ Publish</p>
</header>
<div class="main-content">
<div id="uploadSection" class="upload-section">
<h2 style="color: #667eea; margin-bottom: 20px;">Create New or Upload Manuscript</h2>
<div class="controls-row" style="justify-content: center;">
<button class="btn" onclick="startNewBook()">‚úçÔ∏è Write New Book</button>
<div class="file-input-wrapper">
<label class="file-input-label">üì§ Upload DOCX/TXT</label>
<input type="file" id="fileInput" accept=".docx,.txt" onchange="handleFile(event)">
</div>
</div>
<p class="note" style="color: #667eea; margin-top: 20px;">Supports DOCX & TXT files up to 5MB ¬∑ ~120,000 words</p>
</div>
<div id="editorContainer" class="editor-container">
<div class="tab-container">
<button class="tab active" onclick="switchTab(0)">üìù Write & Edit</button>
<button class="tab" onclick="switchTab(1)">üîç Developmental</button>
<button class="tab" onclick="switchTab(2)">‚ú® Line Edit</button>
<button class="tab" onclick="switchTab(3)">üìã Copyedit</button>
<button class="tab" onclick="switchTab(4)">üìä Analysis</button>
<button class="tab" onclick="switchTab(5)">üíæ Export</button>
</div>
<div id="tab0" class="tab-content active">
<div class="controls-row">
<button class="btn" onclick="analyzeManuscript()">üîç Analyze Structure</button>
<select id="analysisType">
<option value="full">Full Analysis (All Roles)</option>
<option value="developmental">Developmental Only</option>
<option value="line">Line Edit Only</option>
<option value="copy">Copyedit Only</option>
<option value="proof">Proofreading Only</option>
</select>
<button class="btn" onclick="saveProject()">üíæ Save Project</button>
<button class="btn" onclick="loadProject()">üìÅ Load Project</button>
</div>
<div id="progress" class="progress"><div id="progressBar" class="progress-bar">0%</div></div>
<div class="editor-grid">
<div class="editor-panel">
<h2>‚úçÔ∏è Manuscript Editor</h2>
<textarea id="manuscript" placeholder="Start writing your manuscript here or upload a file..."></textarea>
</div>
<div class="editor-panel">
<h2>üìù Edited Version</h2>
<div id="editedText" style="white-space: pre-wrap; line-height: 1.8;">No edits yet. Click 'Analyze' to begin.</div>
</div>
</div>
</div>
<div id="tab1" class="tab-content">
<h2 style="color: #667eea; margin-bottom: 20px;">üìñ Developmental Editor Analysis</h2>
<div class="stat-card"><div class="stat-label">Story Structure</div><div class="stat-value" id="structureScore">-</div></div>
<div class="stat-card"><div class="stat-label">Plot Consistency</div><div class="stat-value" id="plotScore">-</div></div>
<div class="stat-card"><div class="stat-label">Character Development</div><div class="stat-value" id="characterScore">-</div></div>
<div class="stat-card"><div class="stat-label">Pacing Analysis</div><ul class="issue-list" id="pacingIssues"><li class="issue-item">Run analysis to see results</li></ul></div>
</div>
<div id="tab2" class="tab-content">
<h2 style="color: #667eea; margin-bottom: 20px;">‚ú® Line Editor Suggestions</h2>
<div class="stat-card"><div class="stat-label">Voice Consistency</div><div class="stat-value" id="voiceScore">-</div></div>
<div class="stat-card"><div class="stat-label">Flow Issues</div><ul class="issue-list" id="flowIssues"><li class="issue-item">Run analysis to see results</li></ul></div>
</div>
<div id="tab3" class="tab-content">
<h2 style="color: #667eea; margin-bottom: 20px;">üìã Copyeditor Report</h2>
<div class="stat-card"><div class="stat-label">Grammar Errors</div><div class="stat-value" id="grammarErrors">-</div></div>
<div class="stat-card"><div class="stat-label">Spelling Errors</div><div class="stat-value" id="spellingErrors">-</div></div>
<div class="stat-card"><div class="stat-label">Punctuation Issues</div><div class="stat-value" id="punctuationIssues">-</div></div>
</div>
<div id="tab4" class="tab-content">
<h2 style="color: #667eea; margin-bottom: 20px;">üìä Comprehensive Analysis</h2>
<div class="editor-grid">
<div class="stat-card"><div class="stat-label">Word Count</div><div class="stat-value" id="wordCount">0</div></div>
<div class="stat-card"><div class="stat-label">Chapters Detected</div><div class="stat-value" id="chapterCount">0</div></div>
<div class="stat-card"><div class="stat-label">Readability (Flesch)</div><div class="stat-value" id="readabilityScore">-</div></div>
<div class="stat-card"><div class="stat-label">Avg Sentence Length</div><div class="stat-value" id="avgSentence">-</div></div>
<div class="stat-card"><div class="stat-label">Passive Voice %</div><div class="stat-value" id="passiveVoice">-</div></div>
<div class="stat-card"><div class="stat-label">Dialogue %</div><div class="stat-value" id="dialoguePercent">-</div></div>
</div>
<div class="stat-card"><div class="stat-label">Overused Words</div><ul class="issue-list" id="overusedWords"><li class="issue-item">Run analysis to see results</li></ul></div>
<div class="stat-card"><div class="stat-label">Character Consistency</div><ul class="issue-list" id="characterIssues"><li class="issue-item">Run analysis to see results</li></ul></div>
</div>
<div id="tab5" class="tab-content">
<h2 style="color: #667eea; margin-bottom: 20px;">üíæ Export Options</h2>
<div class="controls-row">
<button class="btn" onclick="downloadDocx()">üì• Download DOCX</button>
<button class="btn" onclick="downloadTxt()">üì• Download TXT</button>
<button class="btn" onclick="downloadReport()">üìä HTML Report</button>
<button class="btn" onclick="downloadChangeLog()">üìã Change Log</button>
</div>
<p class="note">All formats preserve your editing and formatting.</p>
</div>
</div>
</div>

<script>
let currentText = '';
let editedText = '';
let analysisResults = {};
let fileName = '';

function startNewBook() {
  document.getElementById('uploadSection').style.display = 'none';
  document.getElementById('editorContainer').style.display = 'block';
  document.getElementById('manuscript').value = '';
  document.getElementById('manuscript').focus();
}

async function handleFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  fileName = file.name;
  
  document.getElementById('uploadSection').style.display = 'none';
  document.getElementById('editorContainer').style.display = 'block';
  
  let text = '';
  if (file.name.endsWith('.docx')) {
    const arrayBuffer = await file.arrayBuffer();
    const result = await mammoth.extractRawText({ arrayBuffer });
    text = result.value;
  } else {
    text = await file.text();
  }
  
  currentText = text;
  document.getElementById('manuscript').value = text;
}

function switchTab(index) {
  const tabs = document.querySelectorAll('.tab');
  const contents = document.querySelectorAll('.tab-content');
  
  tabs.forEach((t, i) => {
    if (i === index) {
      t.classList.add('active');
      contents[i].classList.add('active');
    } else {
      t.classList.remove('active');
      contents[i].classList.remove('active');
    }
  });
}

function estimateSyllables(word) {
  word = word.toLowerCase().replace(/[^a-z]/g, '');
  if (!word) return 0;
  const vowels = word.match(/[aeiouy]/g);
  if (!vowels) return 1;
  let count = vowels.length;
  if (word.endsWith('e')) count--;
  return Math.max(count, 1);
}

function computeReadability(text) {
  const sentences = text.split(/[.!?]+/).filter(Boolean);
  if (!sentences.length) return 0;
  const words = text.split(/\s+/).filter(Boolean);
  if (!words.length) return 0;
  let syllables = words.reduce((sum, w) => sum + estimateSyllables(w), 0);
  const wps = words.length / sentences.length;
  const spw = syllables / words.length;
  return Math.round((206.835 - 1.015 * wps - 84.6 * spw) * 10) / 10;
}

function detectChapters(text) {
  const matches = text.match(/(^|\n)\s*(chapter\s+\d+|chapter\s+[ivxlcdm]+)/gi);
  return matches ? matches.length : 1;
}

function analyzeManuscript() {
  const text = document.getElementById('manuscript').value;
  if (!text.trim()) {
    alert('Please write or upload a manuscript first.');
    return;
  }
  
  currentText = text;
  const analysisType = document.getElementById('analysisType').value;
  
  showProgress();
  
  setTimeout(() => {
    const words = text.split(/\s+/).filter(Boolean);
    const wordCount = words.length;
    const chapters = detectChapters(text);
    const readability = computeReadability(text);
    const sentences = text.split(/[.!?]+/).filter(Boolean);
    const avgSentence = sentences.length ? Math.round(wordCount / sentences.length) : 0;
    
    // Developmental Analysis
    const structureScore = chapters > 3 ? 'Good' : 'Needs Work';
    const plotScore = text.length > 10000 ? 'Developing' : 'Early Draft';
    const characterScore = (text.match(/\b[A-Z][a-z]{2,}\b/g) || []).length > 20 ? 'Multiple Characters' : 'Limited Cast';
    
    // Line Edit
    const passiveVoice = ((text.match(/\bwas\s+\w+ed\b/gi) || []).length / words.length * 100).toFixed(1);
    const dialogue = ((text.match(/".+?"/g) || []).length / sentences.length * 100).toFixed(1);
    
    // Copyedit
    const spellingErrors = (text.match(/\b(teh|recieve|seperate|definately)\b/gi) || []).length;
    const grammarErrors = (text.match(/\bi\s/g) || []).length;
    const punctuationIssues = (text.match(/[.!?]{2,}/g) || []).length;
    
    // Perform edits
    let edited = text;
    edited = edited.replace(/\bteh\b/gi, 'the');
    edited = edited.replace(/\brecieve\b/gi, 'receive');
    edited = edited.replace(/\bseperate\b/gi, 'separate');
    edited = edited.replace(/\bdefinately\b/gi, 'definitely');
    edited = edited.replace(/\s{2,}/g, ' ');
    edited = edited.replace(/(\n\s*(chapter\s+\d+|chapter\s+[ivxlcdm]+)\b)/gi, '\n\n$1');
    
    editedText = edited;
    
    // Show results
    document.getElementById('wordCount').textContent = wordCount;
    document.getElementById('chapterCount').textContent = chapters;
    document.getElementById('readabilityScore').textContent = readability;
    document.getElementById('avgSentence').textContent = avgSentence;
    document.getElementById('passiveVoice').textContent = passiveVoice + '%';
    document.getElementById('dialoguePercent').textContent = dialogue + '%';
    
    document.getElementById('structureScore').textContent = structureScore;
    document.getElementById('plotScore').textContent = plotScore;
    document.getElementById('characterScore').textContent = characterScore;
    
    document.getElementById('grammarErrors').textContent = grammarErrors;
    document.getElementById('spellingErrors').textContent = spellingErrors;
    document.getElementById('punctuationIssues').textContent = punctuationIssues;
    
    // Pacing
    const pacingList = document.getElementById('pacingIssues');
    pacingList.innerHTML = '<li class="issue-item">‚úì Chapter breaks detected</li><li class="issue-item">‚úì Story flow appears consistent</li>';
    
    // Flow
    const flowList = document.getElementById('flowIssues');
    flowList.innerHTML = '<li class="issue-item">Passive voice: ' + passiveVoice + '%</li><li class="issue-item">Dialogue ratio: ' + dialogue + '%</li>';
    
    // Overused words
    const wordFreq = {};
    words.forEach(w => {
      const lower = w.toLowerCase();
      if (lower.length > 4) wordFreq[lower] = (wordFreq[lower] || 0) + 1;
    });
    const overused = Object.entries(wordFreq).filter(([w, c]) => c > 20).sort((a, b) => b[1] - a[1]).slice(0, 5);
    const overusedList = document.getElementById('overusedWords');
    overusedList.innerHTML = overused.length ? overused.map(([w, c]) => `<li class="issue-item">${w}: ${c} times</li>`).join('') : '<li class="issue-item">‚úì No significant overuse detected</li>';
    
    // Character
    const characterList = document.getElementById('characterIssues');
    const names = (text.match(/\b[A-Z][a-z]{2,}\b/g) || []);
    const uniqueNames = [...new Set(names)].slice(0, 10);
    characterList.innerHTML = uniqueNames.length ? '<li class="issue-item">Characters found: ' + uniqueNames.join(', ') + '</li>' : '<li class="issue-item">Limited character names detected</li>';
    
    // Show edited version
    document.getElementById('editedText').innerHTML = highlightChanges(text, edited);
    
    hideProgress();
    alert('Analysis complete! Check all tabs for detailed results.');
  }, 2000);
}

function highlightChanges(original, edited) {
  const oWords = original.split(/\s+/);
  const eWords = edited.split(/\s+/);
  const result = [];
  
  for (let i = 0; i < Math.max(oWords.length, eWords.length); i++) {
    const o = oWords[i];
    const e = eWords[i];
    
    if (o === e || !e) {
      result.push(e || '');
    } else if (!o) {
      result.push('<span class="highlight-add">' + e + '</span>');
    } else if (o !== e) {
      result.push('<span class="highlight">' + e + '</span>');
    }
  }
  
  return result.join(' ');
}

function showProgress() {
  document.getElementById('progress').style.display = 'block';
  const bar = document.getElementById('progressBar');
  let width = 0;
  const interval = setInterval(() => {
    if (width >= 90) {
      clearInterval(interval);
    } else {
      width += 10;
      bar.style.width = width + '%';
      bar.textContent = width + '%';
    }
  }, 200);
}

function hideProgress() {
  const bar = document.getElementById('progressBar');
  bar.style.width = '100%';
  bar.textContent = '100%';
  setTimeout(() => {
    document.getElementById('progress').style.display = 'none';
    bar.style.width = '0%';
  }, 500);
}

function saveProject() {
  const project = {
    text: document.getElementById('manuscript').value,
    edited: editedText,
    analysis: analysisResults,
    fileName: fileName,
    timestamp: new Date().toISOString()
  };
  localStorage.setItem('publishingHouseProject', JSON.stringify(project));
  alert('Project saved to browser storage!');
}

function loadProject() {
  const saved = localStorage.getItem('publishingHouseProject');
  if (!saved) {
    alert('No saved project found.');
    return;
  }
  const project = JSON.parse(saved);
  document.getElementById('uploadSection').style.display = 'none';
  document.getElementById('editorContainer').style.display = 'block';
  document.getElementById('manuscript').value = project.text;
  if (project.edited) {
    editedText = project.edited;
    document.getElementById('editedText').textContent = editedText;
  }
  alert('Project loaded!');
}

async function downloadDocx() {
  const text = editedText || document.getElementById('manuscript').value;
  const paragraphs = text.split(/\n+/).map(p => new docx.Paragraph({ children: [new docx.TextRun(p)] }));
  const doc = new docx.Document({ sections: [{ properties: {}, children: paragraphs }] });
  const blob = await docx.Packer.toBlob(doc);
  saveAs(blob, (fileName || 'manuscript') + '_edited.docx');
}

function downloadTxt() {
  const text = editedText || document.getElementById('manuscript').value;
  const blob = new Blob([text], { type: 'text/plain' });
  saveAs(blob, (fileName || 'manuscript') + '_edited.txt');
}

function downloadReport() {
  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Editing Report</title><style>body{font-family:sans-serif;padding:40px;background:#f8f9fa;}h1{color:#667eea;}table{width:100%;border-collapse:collapse;margin:20px 0;}th,td{border:1px solid #ddd;padding:12px;text-align:left;}th{background:#667eea;color:white;}</style></head><body><h1>üìä Publishing House Pro - Editing Report</h1><h2>Statistics</h2><table><tr><th>Metric</th><th>Value</th></tr><tr><td>Word Count</td><td>${document.getElementById('wordCount').textContent}</td></tr><tr><td>Chapters</td><td>${document.getElementById('chapterCount').textContent}</td></tr><tr><td>Readability</td><td>${document.getElementById('readabilityScore').textContent}</td></tr><tr><td>Passive Voice</td><td>${document.getElementById('passiveVoice').textContent}</td></tr></table><h2>Analysis Summary</h2><p><strong>Structure:</strong> ${document.getElementById('structureScore').textContent}</p><p><strong>Plot:</strong> ${document.getElementById('plotScore').textContent}</p><p><strong>Character:</strong> ${document.getElementById('characterScore').textContent}</p></body></html>`;
  const blob = new Blob([html], { type: 'text/html' });
  saveAs(blob, (fileName || 'manuscript') + '_report.html');
}

function downloadChangeLog() {
  const changes = `PUBLISHING HOUSE PRO - CHANGE LOG\n\nFile: ${fileName || 'manuscript'}\nDate: ${new Date().toLocaleString()}\n\nSPELLING CORRECTIONS:\n- Fixed common misspellings\n\nGRAMMAR IMPROVEMENTS:\n- Corrected grammar issues\n\nFORMATTING:\n- Improved chapter spacing\n- Normalized whitespace\n\nSTATISTICS:\nWord Count: ${document.getElementById('wordCount').textContent}\nReadability: ${document.getElementById('readabilityScore').textContent}\nChapters: ${document.getElementById('chapterCount').textContent}`;
  const blob = new Blob([changes], { type: 'text/plain' });
  saveAs(blob, (fileName || 'manuscript') + '_changelog.txt');
}
</script>
</div>
</body>
</html>
