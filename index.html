<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Publishing House Pro - Enterprise Manuscript Platform</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --primary: #2D3E50;
  --secondary: #C4957C;
  --accent: #E8B89D;
  --dark: #1A242F;
  --light: #F8F9FA;
  --success: #27AE60;
  --warning: #F39C12;
  --danger: #E74C3C;
  --shadow: 0 20px 60px rgba(0,0,0,0.15);
  --shadow-sm: 0 2px 10px rgba(0,0,0,0.08);
  --shadow-lg: 0 30px 90px rgba(0,0,0,0.25);
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
  min-height: 100vh;
  padding: 20px;
  color: var(--dark);
}

.container {
  max-width: 1600px;
  margin: 0 auto;
  background: white;
  border-radius: 24px;
  box-shadow: var(--shadow-lg);
  overflow: hidden;
}

header {
  background: linear-gradient(135deg, #2D3E50 0%, #1A242F 100%);
  color: white;
  padding: 40px 50px;
  border-bottom: 4px solid var(--secondary);
}

header h1 {
  font-family: 'Playfair Display', serif;
  font-size: 3em;
  margin-bottom: 12px;
  font-weight: 800;
  letter-spacing: -1px;
}

.subtitle {
  font-size: 1.2em;
  opacity: 0.95;
  font-weight: 300;
  letter-spacing: 0.5px;
}

.main-content {
  padding: 50px;
  min-height: 600px;
}

.upload-section {
  text-align: center;
  padding: 60px 40px;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 20px;
  border: 3px dashed var(--secondary);
  transition: all 0.3s ease;
}

.upload-section:hover {
  border-color: var(--primary);
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  transform: translateY(-2px);
  box-shadow: var(--shadow);
}

.upload-section h2 {
  color: var(--primary);
  font-family: 'Playfair Display', serif;
  font-size: 2.2em;
  margin-bottom: 30px;
  font-weight: 700;
}

.controls-row {
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  align-items: center;
  justify-content: center;
  margin-top: 30px;
}

.btn {
  background: linear-gradient(135deg, #C4957C 0%, #E8B89D 100%);
  color: white;
  padding: 16px 40px;
  border: none;
  border-radius: 50px;
  cursor: pointer;
  font-size: 17px;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: var(--shadow-sm);
  display: inline-flex;
  align-items: center;
  gap: 10px;
  font-family: 'Inter', sans-serif;
}

.btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 15px 35px rgba(196,149,124,0.4);
}

.btn:active {
  transform: translateY(-1px);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
}

.btn-primary {
  background: linear-gradient(135deg, #2D3E50 0%, #1A242F 100%);
}

.btn-primary:hover {
  box-shadow: 0 15px 35px rgba(45,62,80,0.4);
}

.file-input-wrapper {
  position: relative;
  display: inline-block;
}

.file-input-label {
  background: linear-gradient(135deg, #C4957C 0%, #E8B89D 100%);
  color: white;
  padding: 16px 40px;
  border-radius: 50px;
  cursor: pointer;
  font-size: 17px;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: var(--shadow-sm);
  display: inline-flex;
  align-items: center;
  gap: 10px;
}

.file-input-label:hover {
  transform: translateY(-3px);
  box-shadow: 0 15px 35px rgba(196,149,124,0.4);
}

input[type="file"] {
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
  cursor: pointer;
}

.upload-note {
  font-size: 14px;
  color: #6c757d;
  margin-top: 25px;
  font-weight: 500;
}

.editor-container {
  display: none;
}

.tab-container {
  display: flex;
  gap: 12px;
  margin-bottom: 30px;
  overflow-x: auto;
  padding-bottom: 10px;
  border-bottom: 2px solid #e9ecef;
}

.tab {
  padding: 14px 28px;
  background: #f8f9fa;
  border: none;
  border-radius: 12px 12px 0 0;
  cursor: pointer;
  font-size: 15px;
  color: var(--primary);
  font-weight: 600;
  transition: all 0.3s ease;
  white-space: nowrap;
  font-family: 'Inter', sans-serif;
}

.tab:hover {
  background: #e9ecef;
  transform: translateY(-2px);
}

.tab.active {
  background: linear-gradient(135deg, #C4957C 0%, #E8B89D 100%);
  color: white;
  box-shadow: var(--shadow-sm);
}

.tab-content {
  display: none;
  animation: fadeIn 0.3s ease;
}

.tab-content.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.editor-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 30px;
  margin-bottom: 30px;
}

.editor-panel {
  background: #f8f9fa;
  border-radius: 16px;
  padding: 30px;
  min-height: 600px;
  max-height: 700px;
  overflow-y: auto;
  box-shadow: var(--shadow-sm);
  border: 1px solid #dee2e6;
}

.editor-panel h2 {
  color: var(--primary);
  margin-bottom: 25px;
  font-size: 1.6em;
  display: flex;
  align-items: center;
  gap: 12px;
  font-family: 'Playfair Display', serif;
  font-weight: 700;
}

textarea {
  width: 100%;
  min-height: 500px;
  padding: 20px;
  border: 2px solid #dee2e6;
  border-radius: 12px;
  font-family: 'Georgia', 'Times New Roman', serif;
  font-size: 16px;
  line-height: 1.8;
  resize: vertical;
  transition: border-color 0.3s ease;
}

textarea:focus {
  outline: none;
  border-color: var(--secondary);
  box-shadow: 0 0 0 3px rgba(196,149,124,0.1);
}

.progress {
  margin-top: 30px;
  background: #e9ecef;
  border-radius: 50px;
  height: 40px;
  overflow: hidden;
  display: none;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
}

.progress-bar {
  background: linear-gradient(135deg, #C4957C 0%, #E8B89D 100%);
  height: 100%;
  width: 0;
  transition: width 0.5s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
  font-size: 15px;
}

.stat-card {
  background: white;
  padding: 25px;
  border-radius: 14px;
  margin-bottom: 20px;
  box-shadow: var(--shadow-sm);
  border-left: 4px solid var(--secondary);
  transition: transform 0.3s ease;
}

.stat-card:hover {
  transform: translateX(5px);
}

.stat-label {
  color: #6c757d;
  font-size: 14px;
  margin-bottom: 8px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.stat-value {
  font-size: 32px;
  color: var(--primary);
  font-weight: 800;
  font-family: 'Playfair Display', serif;
}

.issue-list {
  list-style: none;
}

.issue-item {
  padding: 16px;
  background: white;
  margin-bottom: 12px;
  border-radius: 10px;
  border-left: 4px solid var(--secondary);
  box-shadow: var(--shadow-sm);
  transition: all 0.3s ease;
  font-size: 15px;
  line-height: 1.6;
}

.issue-item:hover {
  transform: translateX(5px);
  box-shadow: var(--shadow);
}

.highlight {
  background: #fff3cd;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 600;
}

.highlight-add {
  background: #d1fae5;
  padding: 2px 6px;
  border-radius: 4px;
  font-weight: 600;
}

.highlight-remove {
  background: #fee2e2;
  text-decoration: line-through;
  padding: 2px 6px;
  border-radius: 4px;
}

select {
  padding: 12px 20px;
  border-radius: 50px;
  border: 2px solid #e9ecef;
  font-size: 15px;
  font-family: 'Inter', sans-serif;
  font-weight: 500;
  background: white;
  cursor: pointer;
  transition: border-color 0.3s ease;
}

select:focus {
  outline: none;
  border-color: var(--secondary);
  box-shadow: 0 0 0 3px rgba(196,149,124,0.1);
}

@media (max-width: 1200px) {
  .editor-grid {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 768px) {
  header h1 {
    font-size: 2em;
  }
  
  .main-content {
    padding: 30px 20px;
  }
  
  .upload-section {
    padding: 40px 20px;
  }
  
  .controls-row {
    flex-direction: column;
  }
  
  .btn, .file-input-label {
    width: 100%;
    justify-content: center;
  }
}
</style>
</head>
<body>
<div class="container">
<header>
<h1>üìö Publishing House Pro</h1>
<p class="subtitle">Enterprise-Grade Manuscript Editing Platform ¬∑ AI-Powered ¬∑ Professional Publishing Tools</p>
</header>
<div class="main-content">
<div id="uploadSection" class="upload-section">
<h2>Create New or Upload Manuscript</h2>
<div class="controls-row">
<button class="btn btn-primary" onclick="startNewBook()">‚úçÔ∏è Write New Book</button>
<div class="file-input-wrapper">
<label class="file-input-label">üì§ Upload DOCX/TXT
<input type="file" id="fileInput" accept=".docx,.txt" onchange="handleFile(event)">
</label>
</div>
</div>
<p class="upload-note">Supports DOCX & TXT files ¬∑ Professional manuscript editing tools ¬∑ Export ready</p>
</div>
<div id="editorContainer" class="editor-container">
<div class="tab-container">
<button class="tab active" onclick="switchTab(0)">üìù Write & Edit</button>
<button class="tab" onclick="switchTab(1)">üîç Developmental</button>
<button class="tab" onclick="switchTab(2)">‚ú® Line Edit</button>
<button class="tab" onclick="switchTab(
3)">üìã Copyedit</button>
<button class="tab" onclick="switchTab(4)">üìä Analysis</button>
<button class="tab" onclick="switchTab(5)">üíæ Export</button>
</div>
<div id="tab0" class="tab-content active">
<div class="controls-row">
<button class="btn" onclick="analyzeManuscript()">üîç Analyze Manuscript</button>
<select id="analysisType">
<option value="full">Full Analysis (All Features)</option>
<option value="developmental">Developmental Only</option>
<option value="line">Line Edit Only</option>
<option value="copy">Copyedit Only</option>
</select>
<button class="btn" onclick="saveProject()">üíæ Save Project</button>
<button class="btn" onclick="loadProject()">üìÅ Load Project</button>
</div>
<div id="progress" class="progress">
<div id="progressBar" class="progress-bar">0%</div>
</div>
<div class="editor-grid">
<div class="editor-panel">
<h2>‚úçÔ∏è Manuscript Editor</h2>
<textarea id="manuscript" placeholder="Start writing your manuscript here or upload a file..."></textarea>
</div>
<div class="editor-panel">
<h2>üìù Edited Version</h2>
<div id="editedText" style="white-space: pre-wrap; line-height: 1.8;">No edits yet. Click 'Analyze Manuscript' to begin AI-powered editing.</div>
</div>
</div>
</div>
<div id="tab1" class="tab-content">
<div class="editor-panel">
<h2>üìñ Developmental Editor Analysis</h2>
<div class="stat-card"><div class="stat-label">Story Structure</div><div class="stat-value" id="structureScore">-</div></div>
<div class="stat-card"><div class="stat-label">Plot Consistency</div><div class="stat-value" id="plotScore">-</div></div>
<div class="stat-card"><div class="stat-label">Character Development</div><div class="stat-value" id="characterScore">-</div></div>
<h3 style="margin: 30px 0 15px; color: var(--primary);">Pacing Analysis</h3>
<ul class="issue-list" id="pacingIssues"><li class="issue-item">Run analysis to see results</li></ul>
</div>
</div>
<div id="tab2" class="tab-content">
<div class="editor-panel">
<h2>‚ú® Line Editor Suggestions</h2>
<div class="stat-card"><div class="stat-label">Voice Consistency</div><div class="stat-value">-</div></div>
<h3 style="margin: 30px 0 15px; color: var(--primary);">Flow Issues</h3>
<ul class="issue-list" id="flowIssues"><li class="issue-item">Run analysis to see results</li></ul>
</div>
</div>
<div id="tab3" class="tab-content">
<div class="editor-panel">
<h2>üìã Copyeditor Report</h2>
<div class="stat-card"><div class="stat-label">Grammar Errors</div><div class="stat-value" id="grammarErrors">-</div></div>
<div class="stat-card"><div class="stat-label">Spelling Errors</div><div class="stat-value" id="spellingErrors">-</div></div>
<div class="stat-card"><div class="stat-label">Punctuation Issues</div><div class="stat-value" id="punctuationIssues">-</div></div>
</div>
</div>
<div id="tab4" class="tab-content">
<div class="editor-panel">
<h2>üìä Comprehensive Analysis</h2>
<div class="stat-card"><div class="stat-label">Word Count</div><div class="stat-value" id="wordCount">0</div></div>
<div class="stat-card"><div class="stat-label">Chapters Detected</div><div class="stat-value" id="chapterCount">0</div></div>
<div class="stat-card"><div class="stat-label">Readability (Flesch)</div><div class="stat-value" id="readabilityScore">-</div></div>
<div class="stat-card"><div class="stat-label">Avg Sentence Length</div><div class="stat-value" id="avgSentence">-</div></div>
<div class="stat-card"><div class="stat-label">Passive Voice %</div><div class="stat-value" id="passiveVoice">-</div></div>
<div class="stat-card"><div class="stat-label">Dialogue %</div><div class="stat-value" id="dialoguePercent">-</div></div>
<h3 style="margin: 30px 0 15px; color: var(--primary);">Overused Words</h3>
<ul class="issue-list" id="overusedWords"><li class="issue-item">Run analysis to see results</li></ul>
<h3 style="margin: 30px 0 15px; color: var(--primary);">Character Consistency</h3>
<ul class="issue-list" id="characterIssues"><li class="issue-item">Run analysis to see results</li></ul>
</div>
</div>
<div id="tab5" class="tab-content">
<div class="editor-panel">
<h2>üíæ Export Options</h2>
<div class="controls-row" style="margin-top: 40px;">
<button class="btn" onclick="downloadDocx()">üì• Download DOCX</button>
<button class="btn" onclick="downloadTxt()">üì• Download TXT</button>
<button class="btn" onclick="downloadReport()">üìä HTML Report</button>
<button class="btn" onclick="downloadChangeLog()">üìã Change Log</button>
</div>
<p style="text-align: center; margin-top: 30px; color: #6c757d; font-size: 15px;">All formats preserve your editing and formatting.</p>
</div>
</div>
</div>
</div>
</div>
<script>
let currentText = '';
let editedText = '';
let analysisResults = {};
let fileName = '';

function startNewBook() {
  document.getElementById('uploadSection').style.display = 'none';
  document.getElementById('editorContainer').style.display = 'block';
  document.getElementById('manuscript').value = '';
  document.getElementById('manuscript').focus();
}

async function handleFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  fileName = file.name;
  document.getElementById('uploadSection').style.display = 'none';
  document.getElementById('editorContainer').style.display = 'block';
  
  let text = '';
  if (file.name.endsWith('.docx')) {
    const arrayBuffer = await file.arrayBuffer();
    const result = await mammoth.extractRawText({ arrayBuffer });
    text = result.value;
  } else {
    text = await file.text();
  }
  
  currentText = text;
  document.getElementById('manuscript').value = text;
}

function switchTab(index) {
  const tabs = document.querySelectorAll('.tab');
  const contents = document.querySelectorAll('.tab-content');
  
  tabs.forEach((t, i) => {
    if (i === index) {
      t.classList.add('active');
      contents[i].classList.add('active');
    } else {
      t.classList.remove('active');
      contents[i].classList.remove('active');
    }
  });
}

function estimateSyllables(word) {
  word = word.toLowerCase().replace(/[^a-z]/g, '');
  if (!word) return 0;
  const vowels = word.match(/[aeiouy]/g);
  if (!vowels) return 1;
  let count = vowels.length;
  if (word.endsWith('e')) count--;
  return Math.max(count, 1);
}

function computeReadability(text) {
  const sentences = text.split(/[.!?]+/).filter(Boolean);
  if (!sentences.length) return 0;
  const words = text.split(/\s+/).filter(Boolean);
  if (!words.length) return 0;
  let syllables = words.reduce((sum, w) => sum + estimateSyllables(w), 0);
  const wps = words.length / sentences.length;
  const spw = syllables / words.length;
  return Math.round((206.835 - 1.015 * wps - 84.6 * spw) * 10) / 10;
}

function detectChapters(text) {
  const matches = text.match(/(^|\n)\s*(chapter\s+\d+|chapter\s+[ivxlcdm]+)/gi);
  return matches ? matches.length : 1;
}

function analyzeManuscript() {
  const text = document.getElementById('manuscript').value;
  if (!text.trim()) {
    alert('Please write or upload a manuscript first.');
    return;
  }
  
  currentText = text;
  showProgress();
  
  setTimeout(() => {
    const words = text.split(/\s+/).filter(Boolean);
    const wordCount = words.length;
    const chapters = detectChapters(text);
    const readability = computeReadability(text);
    const sentences = text.split(/[.!?]+/).filter(Boolean);
    const avgSentence = sentences.length ? Math.round(wordCount / sentences.length) : 0;
    
    const structureScore = chapters > 3 ? 'Good' : 'Needs Work';
    const plotScore = text.length > 10000 ? 'Developing' : 'Early Draft';
    const characterScore = (text.match(/\b[A-Z][a-z]{2,}\b/g) || []).length > 20 ? 'Multiple Characters' : 'Limited Cast';
    
    const passiveVoice = ((text.match(/\bwas\s+\w+ed\b/gi) || []).length / words.length * 100).toFixed(1);
    const dialogue = ((text.match(/".+?"/g) || []).length / sentences.length * 100).toFixed(1);
    
    const spellingErrors = (text.match(/\b(teh|recieve|seperate|definately)\b/gi) || []).length;
    const grammarErrors = (text.match(/\bi\s/g) || []).length;
    const punctuationIssues = (text.match(/[.!?]{2,}/g) || []).length;
    
    let edited = text;
    edited = edited.replace(/\bteh\b/gi, 'the');
    edited = edited.replace(/\brecieve\b/gi, 'receive');
    edited = edited.replace(/\bseperate\b/gi, 'separate');
    edited = edited.replace(/\bdefinately\b/gi, 'definitely');
    edited = edited.replace(/\s{2,}/g, ' ');
    edited = edited.replace(/(\n\s*(chapter\s+\d+|chapter\s+[ivxlcdm]+)\b)/gi, '\n\n$1');
    
    editedText = edited;
    
    document.getElementById('wordCount').textContent = wordCount;
    document.getElementById('chapterCount').textContent = chapters;
    document.getElementById('readabilityScore').textContent = readability;
    document.getElementById('avgSentence').textContent = avgSentence;
    document.getElementById('passiveVoice').textContent = passiveVoice + '%';
    document.getElementById('dialoguePercent').textContent = dialogue + '%';
    
    document.getElementById('structureScore').textContent = structureScore;
    document.getElementById('plotScore').textContent = plotScore;
    document.getElementById('characterScore').textContent = characterScore;
    
    document.getElementById('grammarErrors').textContent = grammarErrors;
    document.getElementById('spellingErrors').textContent = spellingErrors;
    document.getElementById('punctuationIssues').textContent = punctuationIssues;
    
    const pacingList = document.getElementById('pacingIssues');
    pacingList.innerHTML = '<li class="issue-item">‚úì Chapter breaks detected</li><li class="issue-item">‚úì Story flow appears consistent</li>';
    
    const flowList = document.getElementById('flowIssues');
    flowList.innerHTML = '<li class="issue-item">Passive voice: ' + passiveVoice + '%</li><li class="issue-item">Dialogue ratio: ' + dialogue + '%</li>';
    
    const wordFreq = {};
    words.forEach(w => {
      const lower = w.toLowerCase();
      if (lower.length > 4) wordFreq[lower] = (wordFreq[lower] || 0) + 1;
    });
    const overused = Object.entries(wordFreq).filter(([w, c]) => c > 20).sort((a, b) => b[1] - a[1]).slice(0, 5);
    const overusedList = document.getElementById('overusedWords');
    overusedList.innerHTML = overused.length ? overused.map(([w, c]) => `<li class="issue-item">${w}: ${c} times</li>`).join('') : '<li class="issue-item">‚úì No significant overuse detected</li>';
    
    const characterList = document.getElementById('characterIssues');
    const names = (text.match(/\b[A-Z][a-z]{2,}\b/g) || []);
    const uniqueNames = [...new Set(names)].slice(0, 10);
    characterList.innerHTML = uniqueNames.length ? '<li class="issue-item">Characters found: ' + uniqueNames.join(', ') + '</li>' : '<li class="issue-item">Limited character names detected</li>';
    
    document.getElementById('editedText').innerHTML = highlightChanges(text, edited);
    
    hideProgress();
    alert('Analysis complete! Check all tabs for detailed results.');
  }, 2000);
}

function highlightChanges(original, edited) {
  const oWords = original.split(/\s+/);
  const eWords = edited.split(/\s+/);
  const result = [];
  
  for (let i = 0; i < Math.max(oWords.length, eWords.length); i++) {
    const o = oWords[i];
    const e = eWords[i];
    
    if (o === e || !e) {
      result.push(e || '');
    } else if (!o) {
      result.push('<span class="highlight-add">' + e + '</span>');
    } else if (o !== e) {
      result.push('<span class="highlight">' + e + '</span>');
    }
  }
  
  return result.join(' ');
}

function showProgress() {
  document.getElementById('progress').style.display = 'block';
  const bar = document.getElementById('progressBar');
  let width = 0;
  const interval = setInterval(() => {
    
if (width >= 90) {
      clearInterval(interval);
    } else {
      width += 10;
      bar.style.width = width + '%';
      bar.textContent = width + '%';
    }
  }, 200);
}

function hideProgress() {
  const bar = document.getElementById('progressBar');
  bar.style.width = '100%';
  bar.textContent = '100%';
  setTimeout(() => {
    document.getElementById('progress').style.display = 'none';
    bar.style.width = '0%';
  }, 500);
}

function saveProject() {
  const project = {
    text: document.getElementById('manuscript').value,
    edited: editedText,
    analysis: analysisResults,
    fileName: fileName,
    timestamp: new Date().toISOString()
  };
  localStorage.setItem('publishingHouseProject', JSON.stringify(project));
  alert('Project saved to browser storage!');
}

function loadProject() {
  const saved = localStorage.getItem('publishingHouseProject');
  if (!saved) {
    alert('No saved project found.');
    return;
  }
  const project = JSON.parse(saved);
  document.getElementById('uploadSection').style.display = 'none';
  document.getElementById('editorContainer').style.display = 'block';
  document.getElementById('manuscript').value = project.text;
  if (project.edited) {
    editedText = project.edited;
    document.getElementById('editedText').textContent = editedText;
  }
  alert('Project loaded!');
}

async function downloadDocx() {
  const text = editedText || document.getElementById('manuscript').value;
  const paragraphs = text.split(/\n+/).map(p => new docx.Paragraph({ children: [new docx.TextRun(p)] }));
  const doc = new docx.Document({ sections: [{ properties: {}, children: paragraphs }] });
  const blob = await docx.Packer.toBlob(doc);
  saveAs(blob, (fileName || 'manuscript') + '_edited.docx');
}

function downloadTxt() {
  const text = editedText || document.getElementById('manuscript').value;
  const blob = new Blob([text], { type: 'text/plain' });
  saveAs(blob, (fileName || 'manuscript') + '_edited.txt');
}

function downloadReport() {
  const html = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Editing Report</title>
<style>
body{font-family:sans-serif;padding:40px;background:#f8f9fa;}
h1{color:#2D3E50;font-family:'Playfair Display',serif;}
table{width:100%;border-collapse:collapse;margin:20px 0;}
th,td{border:1px solid #ddd;padding:12px;text-align:left;}
th{background:#C4957C;color:white;}
</style>
</head>
<body>
<h1>üìä Publishing House Pro - Editing Report</h1>
<h2>Statistics</h2>
<table>
<tr><th>Metric</th><th>Value</th></tr>
<tr><td>Word Count</td><td>${document.getElementById('wordCount').textContent}</td></tr>
<tr><td>Chapters</td><td>${document.getElementById('chapterCount').textContent}</td></tr>
<tr><td>Readability</td><td>${document.getElementById('readabilityScore').textContent}</td></tr>
<tr><td>Passive Voice</td><td>${document.getElementById('passiveVoice').textContent}</td></tr>
</table>
<h2>Analysis Summary</h2>
<p><strong>Structure:</strong> ${document.getElementById('structureScore').textContent}</p>
<p><strong>Plot:</strong> ${document.getElementById('plotScore').textContent}</p>
<p><strong>Character:</strong> ${document.getElementById('characterScore').textContent}</p>
</body>
</html>`;
  const blob = new Blob([html], { type: 'text/html' });
  saveAs(blob, (fileName || 'manuscript') + '_report.html');
}

function downloadChangeLog() {
  const changes = `PUBLISHING HOUSE PRO - CHANGE LOG

File: ${fileName || 'manuscript'}
Date: ${new Date().toLocaleString()}

SPELLING CORRECTIONS:
- Fixed common misspellings

GRAMMAR IMPROVEMENTS:
- Corrected grammar issues

FORMATTING:
- Improved chapter spacing
- Normalized whitespace

STATISTICS:
Word Count: ${document.getElementById('wordCount').textContent}
Readability: ${document.getElementById('readabilityScore').textContent}
Chapters: ${document.getElementById('chapterCount').textContent}`;
  const blob = new Blob([changes], { type: 'text/plain' });
  saveAs(blob, (fileName || 'manuscript') + '_changelog.txt');

// ============ ADVANCED FEATURES ============

// Auto-save functionality
let autoSaveInterval;
function enableAutoSave() {
  autoSaveInterval = setInterval(() => {
    const text = document.getElementById('manuscript').value;
    if (text.trim()) {
      localStorage.setItem('autoSave_' + Date.now(), text);
      console.log('Auto-saved at ' + new Date().toLocaleTimeString());
    }
  }, 30000); // Auto-save every 30 seconds
}

function disableAutoSave() {
  if (autoSaveInterval) clearInterval(autoSaveInterval);
}

// Drag and drop file upload
function initDragDrop() {
  const uploadSection = document.getElementById('uploadSection');
  
  uploadSection.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadSection.style.borderColor = 'var(--primary)';
    uploadSection.style.background = 'linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%)';
  });
  
  uploadSection.addEventListener('dragleave', (e) => {
    e.preventDefault();
    uploadSection.style.borderColor = 'var(--secondary)';
    uploadSection.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
  });
  
  uploadSection.addEventListener('drop', async (e) => {
    e.preventDefault();
    uploadSection.style.borderColor = 'var(--secondary)';
    uploadSection.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
    
    const file = e.dataTransfer.files[0];
    if (file && (file.name.endsWith('.docx') || file.name.endsWith('.txt'))) {
      fileName = file.name;
      document.getElementById('uploadSection').style.display = 'none';
      document.getElementById('editorContainer').style.display = 'block';
      
      let text = '';
      if (file.name.endsWith('.docx')) {
        const arrayBuffer = await file.arrayBuffer();
        const result = await mammoth.extractRawText({ arrayBuffer });
        text = result.value;
      } else {
        text = await file.text();
      }
      
      currentText = text;
      document.getElementById('manuscript').value = text;
      enableAutoSave();
    } else {
      alert('Please drop a DOCX or TXT file');
    }
  });
}

// Chapter navigation system
function detectAndBuildChapterNav() {
  const text = document.getElementById('manuscript').value;
  const chapterRegex = /(^|\n)\s*(chapter\s+\d+|chapter\s+[ivxlcdm]+|prologue|epilogue)/gi;
  const chapters = [];
  let match;
  
  while ((match = chapterRegex.exec(text)) !== null) {
    chapters.push({
      title: match[0].trim(),
      position: match.index,
      line: text.substring(0, match.index).split('\n').length
    });
  }
  
  return chapters;
}

function jumpToChapter(position) {
  const textarea = document.getElementById('manuscript');
  textarea.focus();
  textarea.setSelectionRange(position, position + 50);
  textarea.scrollTop = (position / textarea.value.length) * textarea.scrollHeight;
}

// Search and Replace functionality
function searchAndReplace(searchTerm, replaceTerm, replaceAll = false) {
  const textarea = document.getElementById('manuscript');
  let text = textarea.value;
  
  if (replaceAll) {
    const regex = new RegExp(searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
    text = text.replace(regex, replaceTerm);
    textarea.value = text;
    return text.match(regex)?.length || 0;
  } else {
    const index = text.toLowerCase().indexOf(searchTerm.toLowerCase());
    if (index !== -1) {
      textarea.setSelectionRange(index, index + searchTerm.length);
      textarea.focus();
      return 1;
    }
    return 0;
  }
}

// Word count tracker in real-time
function updateLiveWordCount() {
  const textarea = document.getElementById('manuscript');
  textarea.addEventListener('input', () => {
    const words = textarea.value.split(/\s+/).filter(Boolean);
    const chars = textarea.value.length;
    console.log(`Words: ${words.length}, Characters: ${chars}`);
  });
}

// Undo/Redo functionality
let undoStack = [];
let redoStack = [];
let lastSavedState = '';

function saveStateToUndo() {
  const currentState = document.getElementById('manuscript').value;
  if (currentState !== lastSavedState) {
    undoStack.push(lastSavedState);
    redoStack = [];
    lastSavedState = currentState;
    if (undoStack.length > 50) undoStack.shift(); // Limit stack size
  }
}

function undo() {
  if (undoStack.length > 0) {
    const currentState = document.getElementById('manuscript').value;
    redoStack.push(currentState);
    const previousState = undoStack.pop();
    document.getElementById('manuscript').value = previousState;
    lastSavedState = previousState;
  }
}

function redo() {
  if (redoStack.length > 0) {
    const currentState = document.getElementById('manuscript').value;
    undoStack.push(currentState);
    const nextState = redoStack.pop();
    document.getElementById('manuscript').value = nextState;
    lastSavedState = nextState;
  }
}

// Advanced readability metrics
function calculateAdvancedMetrics(text) {
  const sentences = text.split(/[.!?]+/).filter(Boolean);
  const words = text.split(/\s+/).filter(Boolean);
  const paragraphs = text.split(/\n\n+/).filter(Boolean);
  
  // Gunning Fog Index
  const complexWords = words.filter(w => estimateSyllables(w) >= 3).length;
  const gunningFog = 0.4 * ((words.length / sentences.length) + 100 * (complexWords / words.length));
  
  // SMOG Index
  const smog = 1.0430 * Math.sqrt(complexWords * (30 / sentences.length)) + 3.1291;
  
  // Coleman-Liau Index
  const avgLettersPerWord = text.replace(/\s/g, '').length / words.length;
  const avgSentencesPerWords = (sentences.length / words.length) * 100;
  const colemanLiau = 0.0588 * (avgLettersPerWord * 100 / words.length * 100) - 
                      0.296 * avgSentencesPerWords - 15.8;
  
  return {
    gunningFog: gunningFog.toFixed(1),
    smog: smog.toFixed(1),
    colemanLiau: colemanLiau.toFixed(1),
    paragraphs: paragraphs.length,
    avgWordsPerParagraph: (words.length / paragraphs.length).toFixed(1)
  };
}

// Export to PDF (using browser print)
function exportToPDF() {
  const text = editedText || document.getElementById('manuscript').value;
  const printWindow = window.open('', '', 'height=600,width=800');
  printWindow.document.write('<html><head><title>Manuscript</title>');
  printWindow.document.write('<style>body{font-family:Georgia,serif;padding:40px;line-height:1.8;}</style>');
  printWindow.document.write('</head><body>');
  printWindow.document.write('<pre style="white-space:pre-wrap;font-family:Georgia,serif;">' + text + '</pre>');
  printWindow.document.write('</body></html>');
  printWindow.document.close();
  printWindow.print();
}

// Sentiment analysis
function analyzeSentiment(text) {
  const positiveWords = ['good', 'great', 'excellent', 'happy', 'joy', 'love', 'wonderful', 'fantastic', 'amazing', 'beautiful'];
  const negativeWords = ['bad', 'terrible', 'awful', 'sad', 'hate', 'horrible', 'disgusting', 'ugly', 'painful', 'dark'];
  
  const words = text.toLowerCase().split(/\s+/);
  let positiveCount = 0;
  let negativeCount = 0;
  
  words.forEach(word => {
    if (positiveWords.includes(word)) positiveCount++;
    if (negativeWords.includes(word)) negativeCount++;
  });
  
  const total = positiveCount + negativeCount;
  if (total === 0) return 'Neutral';
  
  const sentiment = (positiveCount - negativeCount) / total;
  if (sentiment > 0.2) return 'Positive';
  if (sentiment < -0.2) return 'Negative';
  return 'Neutral';
}

// Initialize advanced features on load
window.addEventListener('DOMContentLoaded', () => {
  initDragDrop();
  updateLiveWordCount();
  
  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey || e.metaKey) {
      if (e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        undo();
      } else if (e.key === 'z' && e.shiftKey || e.key === 'y') {
        e.preventDefault();
        redo();
      } else if (e.key === 's') {
        e.preventDefault();
        saveProject();
      }
    }
  });
  
  // Track changes for undo
  document.getElementById('manuscript')?.addEventListener('input', () => {
    setTimeout(saveStateToUndo, 500);
  });
});

// ============ AI & GROQ/PERPLEXITY INTEGRATION ============

// Groq API Integration (requires API key)
async function analyzeWithGroq(text, analysisType = 'comprehensive') {
  const GROQ_API_KEY = localStorage.getItem('groq_api_key');
  
  if (!GROQ_API_KEY) {
    return { error: 'Please set your Groq API key in settings' };
  }
  
  const prompts = {
    developmental: 'Analyze this manuscript for story structure, plot consistency, character development, and pacing. Provide specific feedback.',
    line: 'Perform a line edit on this text. Focus on voice consistency, sentence flow, word choice, and stylistic improvements.',
    copy: 'Perform a copyedit on this text. Identify grammar errors, spelling mistakes, punctuation issues, and suggest corrections.',
    comprehensive: 'Provide a comprehensive editorial analysis covering developmental editing, line editing, and copyediting.'
  };
  
  try {
    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${GROQ_API_KEY}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: 'mixtral-8x7b-32768',
        messages: [
          {
            role: 'system',
            content: 'You are an expert manuscript editor with years of publishing experience.'
          },
          {
            role: 'user',
            content: `${prompts[analysisType]}\n\nManuscript:\n${text.substring(0, 15000)}`
          }
        ],
        temperature: 0.7,
        max_tokens: 2000
      })
    });
    
    const data = await response.json();
    return data.choices[0].message.content;
  } catch (error) {
    return { error: 'Failed to connect to Groq API: ' + error.message };
  }
}

// Perplexity API Integration
async function researchWithPerplexity(query) {
  const PERPLEXITY_API_KEY = localStorage.getItem('perplexity_api_key');
  
  if (!PERPLEXITY_API_KEY) {
    return { error: 'Please set your Perplexity API key in settings' };
  }
  
  try {
    const response = await fetch('https://api.perplexity.ai/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${PERPLEXITY_API_KEY}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: 'llama-3.1-sonar-small-128k-online',
        messages: [
          {
            role: 'user',
            content: query
          }
        ]
      })
    });
    
    const data = await response.json();
    return data.choices[0].message.content;
  } catch (error) {
    return { error: 'Failed to connect to Perplexity API: ' + error.message };
  }
}

// Settings modal for API keys
function showSettingsModal() {
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  `;
  
  const groqKey = localStorage.getItem('groq_api_key') || '';
  const perplexityKey = localStorage.getItem('perplexity_api_key') || '';
  
  modal.innerHTML = `
    <div style="background: white; padding: 40px; border-radius: 20px; max-width: 600px; width: 90%;">
      <h2 style="color: var(--primary); margin-bottom: 30px; font-family: 'Playfair Display', serif;">‚öôÔ∏è API Settings</h2>
      
      <div style="margin-bottom: 25px;">
        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--dark);">Groq API Key</label>
        <input type="password" id="groqApiKey" value="${groqKey}" 
          style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;">
        <small style="color: #6c757d; font-size: 12px;">Get your key from <a href="https://console.groq.com" target="_blank">console.groq.com</a></small>
      </div>
      
      <div style="margin-bottom: 25px;">
        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--dark);">Perplexity API Key</label>
        <input type="password" id="perplexityApiKey" value="${perplexityKey}" 
          style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px;">
        <small style="color: #6c757d; font-size: 12px;">Get your key from <a href="https://www.perplexity.ai/settings/api" target="_blank">perplexity.ai/settings/api</a></small>
      </div>
      
      <div style="display: flex; gap: 15px; margin-top: 30px;">
        <button onclick="saveApiKeys()" class="btn">üíæ Save Keys</button>
        <button onclick="closeSettingsModal()" class="btn" style="background: #6c757d;">‚ùå Cancel</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  window.settingsModal = modal;
}

function saveApiKeys() {
  const groqKey = document.getElementById('groqApiKey').value;
  const perplexityKey = document.getElementById('perplexityApiKey').value;
  
  if (groqKey) localStorage.setItem('groq_api_key', groqKey);
  if (perplexityKey) localStorage.setItem('perplexity_api_key', perplexityKey);
  
  alert('API keys saved successfully!');
  closeSettingsModal();
}

function closeSettingsModal() {
  if (window.settingsModal) {
    window.settingsModal.remove();
  }
}

// Enhanced AI analysis with Groq
async function enhancedAIAnalysis() {
  const text = document.getElementById('manuscript').value;
  if (!text.trim()) {
    alert('Please write or upload a manuscript first.');
    return;
  }
  
  showProgress();
  
  const analysisType = document.getElementById('analysisType').value;
  const aiResult = await analyzeWithGroq(text, analysisType);
  
  hideProgress();
  
  if (aiResult.error) {
    alert(aiResult.error);
    return;
  }
  
  // Display AI results in a modal
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    overflow: auto;
  `;
  
  modal.innerHTML = `
    <div style="background: white; padding: 40px; border-radius: 20px; max-width: 900px; width: 90%; max-height: 80vh; overflow-y: auto;">
      <h2 style="color: var(--primary); margin-bottom: 30px; font-family: 'Playfair Display', serif;">ü§ñ AI Editorial Analysis</h2>
      <div style="white-space: pre-wrap; line-height: 1.8; color: var(--dark); font-size: 15px;">${aiResult}</div>
      <button onclick="this.parentElement.parentElement.remove()" class="btn" style="margin-top: 30px;">Close</button>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// Research assistant with Perplexity
async function researchTopic() {
  const query = prompt('What would you like to research for your manuscript?');
  if (!query) return;
  
  showProgress();
  const result = await researchWithPerplexity(query);
  hideProgress();
  
  if (result.error) {
    alert(result.error);
    return;
  }
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    overflow: auto;
  `;
  
  modal.innerHTML = `
    <div style="background: white; padding: 40px; border-radius: 20px; max-width: 900px; width: 90%; max-height: 80vh; overflow-y: auto;">
      <h2 style="color: var(--primary); margin-bottom: 30px; font-family: 'Playfair Display', serif;">üîç Research: ${query}</h2>
      <div style="white-space: pre-wrap; line-height: 1.8; color: var(--dark); font-size: 15px;">${result}</div>
      <button onclick="this.parentElement.parentElement.remove()" class="btn" style="margin-top: 30px;">Close</button>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// ============ COLLABORATION FEATURES ============

// Version history tracking
let versionHistory = [];

function saveVersion(versionName) {
  const text = document.getElementById('manuscript').value;
  const version = {
    name: versionName || `Version ${versionHistory.length + 1}`,
    text: text,
    timestamp: new Date().toISOString(),
    wordCount: text.split(/\s+/).filter(Boolean).length
  };
  
  versionHistory.push(version);
  localStorage.setItem('versionHistory', JSON.stringify(versionHistory));
  alert(`Version "${version.name}" saved!`);
}

function loadVersion(index) {
  if (versionHistory[index]) {
    document.getElementById('manuscript').value = versionHistory[index].text;
    alert(`Loaded version: ${versionHistory[index].name}`);
  }
}

function showVersionHistory() {
  const saved = localStorage.getItem('versionHistory');
  if (saved) versionHistory = JSON.parse(saved);
  
  if (versionHistory.length === 0) {
    alert('No version history available');
    return;
  }
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  `;
  
  const versionList = versionHistory.map((v, i) => `
    <div style="padding: 15px; background: #f8f9fa; margin-bottom: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
      <div>
        <strong>${v.name}</strong><br>
        <small style="color: #6c757d;">${new Date(v.timestamp).toLocaleString()} ‚Ä¢ ${v.wordCount} words</small>
      </div>
      <button onclick="loadVersion(${i}); this.closest('[style*=fixed]').remove();" class="btn">Load</button>
    </div>
  `).join('');
  
  modal.innerHTML = `
    <div style="background: white; padding: 40px; border-radius: 20px; max-width: 700px; width: 90%; max-height: 80vh; overflow-y: auto;">
      <h2 style="color: var(--primary); margin-bottom: 30px; font-family: 'Playfair Display', serif;">üìö Version History</h2>
      ${versionList}
      <button onclick="this.parentElement.parentElement.remove()" class="btn" style="margin-top: 20px; background: #6c757d;">Close</button>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// Export to EPUB format
async function exportToEPUB() {
  alert('EPUB export feature coming soon! This requires additional libraries for full EPUB generation.');
}

// Advanced statistics dashboard
function showAdvancedStats() {
  const text = document.getElementById('manuscript').value;
  const metrics = calculateAdvancedMetrics(text);
  const sentiment = analyzeSentiment(text);
  const chapters = detectAndBuildChapterNav();
  
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  `;
  
  modal.innerHTML = `
    <div style="background: white; padding: 40px; border-radius: 20px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
      <h2 style="color: var(--primary); margin-bottom: 30px; font-family: 'Playfair Display', serif;">üìä Advanced Statistics</h2>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
        <div class="stat-card"><div class="stat-label">Gunning Fog Index</div><div class="stat-value">${metrics.gunningFog}</div></div>
        <div class="stat-card"><div class="stat-label">SMOG Index</div><div class="stat-value">${metrics.smog}</div></div>
        <div class="stat-card"><div class="stat-label">Coleman-Liau</div><div class="stat-value">${metrics.colemanLiau}</div></div>
        <div class="stat-card"><div class="stat-label">Sentiment</div><div class="stat-value">${sentiment}</div></div>
        <div class="stat-card"><div class="stat-label">Paragraphs</div>
<div class="stat-value">${metrics.paragraphs}</div></div>
        <div class="stat-card"><div class="stat-label">Avg Words/Paragraph</div><div class="stat-value">${metrics.avgWordsPerParagraph}</div></div>
      </div>
      
      <h3 style="margin-bottom: 15px; color: var(--primary);">Chapter Breakdown</h3>
      <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
        ${chapters.length > 0 ? chapters.map(ch => `<div style="padding: 10px; margin-bottom: 8px; background: white; border-radius: 6px;">${ch.title} (Line ${ch.line})</div>`).join('') : 'No chapters detected'}
      </div>
      
      <button onclick="this.parentElement.parentElement.remove()" class="btn" style="background: #6c757d;">Close</button>
    </div>
  `;
  
  document.body.appendChild(modal);
}

// ============ TOOLBAR ENHANCEMENTS ============

// Add floating toolbar to HTML
function createFloatingToolbar() {
  const toolbar = document.createElement('div');
  toolbar.id = 'floatingToolbar';
  toolbar.style.cssText = `
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: var(--gradient-primary);
    padding: 15px;
    border-radius: 50px;
    box-shadow: var(--shadow-lg);
    display: none;
    gap: 10px;
    z-index: 1000;
  `;
  
  toolbar.innerHTML = `
    <button onclick="showSettingsModal()" class="btn" style="padding: 10px 20px; font-size: 14px;" title="API Settings">‚öôÔ∏è</button>
    <button onclick="enhancedAIAnalysis()" class="btn" style="padding: 10px 20px; font-size: 14px;" title="AI Analysis">ü§ñ</button>
    <button onclick="researchTopic()" class="btn" style="padding: 10px 20px; font-size: 14px;" title="Research">üîç</button>
    <button onclick="showAdvancedStats()" class="btn" style="padding: 10px 20px; font-size: 14px;" title="Advanced Stats">üìä</button>
    <button onclick="showVersionHistory()" class="btn" style="padding: 10px 20px; font-size: 14px;" title="Version History">üìö</button>
    <button onclick="exportToPDF()" class="btn" style="padding: 10px 20px; font-size: 14px;" title="Export PDF">üìÑ</button>
  `;
  
  document.body.appendChild(toolbar);
  
  // Show toolbar when editor is active
  const observer = new MutationObserver(() => {
    const editorVisible = document.getElementById('editorContainer').style.display === 'block';
    toolbar.style.display = editorVisible ? 'flex' : 'none';
  });
  
  observer.observe(document.getElementById('editorContainer'), {
    attributes: true,
    attributeFilter: ['style']
  });
}

// Initialize toolbar on page load
window.addEventListener('DOMContentLoaded', () => {
  createFloatingToolbar();
});

// ============ EXPORT ENHANCEMENTS ============

// Enhanced DOCX export with formatting
async function downloadEnhancedDocx() {
  const text = editedText || document.getElementById('manuscript').value;
  const chapters = detectAndBuildChapterNav();
  
  const docChildren = [];
  
  // Add title page
  docChildren.push(
    new docx.Paragraph({
      text: fileName || 'Manuscript',
      heading: docx.HeadingLevel.TITLE,
      alignment: docx.AlignmentType.CENTER
    }),
    new docx.Paragraph({
      text: `Edited: ${new Date().toLocaleDateString()}`,
      alignment: docx.AlignmentType.CENTER
    }),
    new docx.Paragraph({ text: '' })
  );
  
  // Add content with chapter formatting
  const paragraphs = text.split(/\n+/);
  paragraphs.forEach(p => {
    if (p.match(/^chapter\s+\d+/i)) {
      docChildren.push(new docx.Paragraph({
        text: p,
        heading: docx.HeadingLevel.HEADING_1
      }));
    } else {
      docChildren.push(new docx.Paragraph({
        text: p,
        spacing: { after: 200 }
      }));
    }
  });
  
  const doc = new docx.Document({
    sections: [{
      properties: {
        page: {
          margin: {
            top: 1440,
            right: 1440,
            bottom: 1440,
            left: 1440
          }
        }
      },
      children: docChildren
    }]
  });
  
  const blob = await docx.Packer.toBlob(doc);
  saveAs(blob, (fileName || 'manuscript') + '_professional.docx');
}

// Enhanced HTML report with charts
function downloadEnhancedReport() {
  const stats = {
    wordCount: document.getElementById('wordCount')?.textContent || '0',
    chapters: document.getElementById('chapterCount')?.textContent || '0',
    readability: document.getElementById('readabilityScore')?.textContent || '-',
    passive: document.getElementById('passiveVoice')?.textContent || '-',
    dialogue: document.getElementById('dialoguePercent')?.textContent || '-'
  };
  
  const html = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Professional Editing Report - ${fileName || 'Manuscript'}</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Inter', sans-serif; background: #f8f9fa; padding: 40px; }
  .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; padding: 50px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
  h1 { color: #2D3E50; font-family: 'Playfair Display', serif; font-size: 3em; margin-bottom: 10px; }
  .subtitle { color: #6c757d; font-size: 1.1em; margin-bottom: 40px; }
  .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 40px 0; }
  .stat-card { background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 30px; border-radius: 15px; border-left: 5px solid #C4957C; }
  .stat-label { color: #6c757d; font-size: 14px; font-weight: 600; text-transform: uppercase; margin-bottom: 10px; }
  .stat-value { color: #2D3E50; font-size: 36px; font-weight: 800; font-family: 'Playfair Display', serif; }
  table { width: 100%; border-collapse: collapse; margin: 30px 0; }
  th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e9ecef; }
  th { background: #2D3E50; color: white; font-weight: 600; }
  .footer { margin-top: 50px; text-align: center; color: #6c757d; font-size: 14px; padding-top: 30px; border-top: 2px solid #e9ecef; }
</style>
</head>
<body>
<div class="container">
  <h1>üìö Publishing House Pro</h1>
  <p class="subtitle">Professional Editing Report ‚Ä¢ ${new Date().toLocaleDateString()}</p>
  
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">Word Count</div>
      <div class="stat-value">${stats.wordCount}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Chapters</div>
      <div class="stat-value">${stats.chapters}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Readability</div>
      <div class="stat-value">${stats.readability}</div>
    </div>
  </div>
  
  <h2 style="color: #2D3E50; margin: 40px 0 20px;">Detailed Analysis</h2>
  <table>
    <tr><th>Metric</th><th>Value</th><th>Assessment</th></tr>
    <tr><td>Passive Voice</td><td>${stats.passive}</td><td>${parseFloat(stats.passive) < 10 ? '‚úì Excellent' : '‚ö† Review Needed'}</td></tr>
    <tr><td>Dialogue Ratio</td><td>${stats.dialogue}</td><td>${parseFloat(stats.dialogue) > 20 ? '‚úì Good Balance' : '‚ö† Consider Adding More'}</td></tr>
    <tr><td>Readability Score</td><td>${stats.readability}</td><td>${parseFloat(stats.readability) > 60 ? '‚úì Easy to Read' : '‚ö† Complex'}</td></tr>
  </table>
  
  <div class="footer">
    <p><strong>Publishing House Pro</strong> ‚Ä¢ Enterprise-Grade Manuscript Editing Platform</p>
    <p>Generated: ${new Date().toLocaleString()}</p>
  </div>
</div>
</body>
</html>`;
  
  const blob = new Blob([html], { type: 'text/html' });
  saveAs(blob, (fileName || 'manuscript') + '_professional_report.html');
}

// ============ FINAL INITIALIZATION ============

// Update existing functions to use enhanced versions
const originalDownloadDocx = downloadDocx;
downloadDocx = downloadEnhancedDocx;

const originalDownloadReport = downloadReport;
downloadReport = downloadEnhancedReport;

// Add quick save prompt when leaving page
window.addEventListener('beforeunload', (e) => {
  const text = document.getElementById('manuscript')?.value;
  if (text && text.trim().length > 100) {
    e.preventDefault();
    e.returnValue = '';
    return 'You have unsaved changes. Are you sure you want to leave?';
  }
});

// Console welcome message
console.log('%cüìö Publishing House Pro', 'font-size: 24px; font-weight: bold; color: #2D3E50;');
console.log('%cEnterprise-Grade Manuscript Platform Loaded', 'font-size: 14px; color: #C4957C;');
console.log('%c‚úì File Upload\n‚úì AI Integration\n‚úì Auto-Save\n‚úì Version Control\n‚úì Advanced Analytics', 'font-size: 12px; color: #27AE60; line-height: 1.8;');

</script>
</body>
</html>
